# Twitter URL Direct - プロジェクト構造と機能説明

このドキュメントは、TwitterURLDirect（Twitterのいいねから画像・動画をダウンロードするツール）の全体構造と処理の流れを説明します。プログラムの理解とメンテナンスを容易にするために作成されています。

## プロジェクトの目的

TwitterURLDirectは、Twitterから「いいね」したツイートのメディア（画像・動画）とメタデータを自動的にダウンロードして保存するツールです。主に以下の機能を提供します：

1. Twitterからエクスポートしたいいねデータを解析
2. 各いいねに含まれるメディアファイル（画像・動画）をダウンロード
3. ツイートのメタデータをJSON形式で保存
4. 進捗状況のリアルタイム表示
5. エラー発生時のスキップとログ記録

## ファイル構成

```
twitterurldirect/
│
├── index.js               # メインエントリーポイント
├── fix-skip-lists.js      # スキップリスト修正ツールのエントリーポイント
├── like.js                # Twitterからエクスポートされたいいねデータ
│
├── src/                   # ソースコードディレクトリ
│   ├── index.js           # メイン実行スクリプト
│   ├── fix-skip-lists.js  # スキップリスト修正ツール
│   │
│   ├── config/            # 設定ファイル
│   │   └── config.js      # プログラム全体の設定
│   │
│   ├── services/          # 主要サービス
│   │   ├── media-service.js         # メディア処理サービス
│   │   └── twitter-api-service.js   # Twitter API連携サービス
│   │
│   └── utils/             # ユーティリティ関数群
│       ├── download-utils.js   # ダウンロード用ユーティリティ
│       ├── error-handlers.js   # エラー処理ユーティリティ
│       ├── file-utils.js       # ファイル操作ユーティリティ
│       ├── list-handlers.js    # スキップリスト管理
│       └── progress-bar.js     # 進捗表示ユーティリティ
│
├── downloaded_images/     # ダウンロードされたメディアとメタデータの保存先
└── logs/                  # エラーログとスキップリストの保存先
```

## 主要なモジュールと役割

### メインプロセス (src/index.js)

メインプロセスは `downloadAllImages` 関数で実装されており、以下の処理を行います：

1. いいねデータの読み込み
2. スキップリストとダウンロード済みファイルの確認
3. 各いいねの反復処理：
   - スキップすべきツイートかチェック
   - すでにダウンロード済みかチェック
   - ツイートからメディアとメタデータを取得
   - ファイルのダウンロードと保存
   - 処理結果に基づく統計データの更新
4. 進捗や結果の表示
5. エラーログの保存

### ユーティリティモジュール

#### list-handlers.js

スキップリストを管理するモジュールで、以下の機能を提供します：
- スキップリストの読み込み・保存
- 各種スキップリスト（存在しないツイート、センシティブコンテンツなど）の管理
- ツイートがスキップ対象かどうかのチェック

#### file-utils.js

ファイル操作に関するユーティリティで、主に以下の機能を提供します：
- いいねデータの読み込み
- ダウンロード済みファイルの検出
- メタデータの保存

#### error-handlers.js

エラー処理とログに関するユーティリティで、以下の機能を提供します：
- エラーログの記録・保存
- エラータイプの判別
- 待機処理（sleep関数）

#### progress-bar.js

コンソール出力と進捗表示に関するユーティリティで、以下の機能を提供します：
- カラフルなコンソール出力
- 進捗バーの表示
- 時間や容量の書式設定

#### download-utils.js

ファイルダウンロードに関するユーティリティで、以下の機能を提供します：
- HTTP/HTTPSリクエスト送信
- ファイルのダウンロードと進捗表示
- コンテンツタイプの判別

### サービスモジュール

#### media-service.js

メディア処理の中心となるモジュールで、以下の処理を担当します：
- ツイートのメディア抽出
- ダウンロード処理の調整
- メタデータの保存

#### twitter-api-service.js

Twitter APIとの連携を担当するモジュールで、以下の処理を行います：
- ツイート情報の取得
- メディアURLの抽出
- レート制限対応

### スキップリスト修正ツール (src/fix-skip-lists.js)

エラーログから問題のあるツイートIDを収集し、適切なスキップリストに分類するツールです。
主に以下の処理を行います：
- エラーログファイルの検索と読み込み
- エラータイプに基づくIDの分類
- 各種スキップリストの更新と保存

## データフロー

1. `index.js` がエントリーポイントとなり、`src/index.js` のメイン処理が実行される
2. `src/index.js` はいいねデータを読み込み、スキップリストをチェック
3. 処理対象のツイートは `media-service.js` に渡される
4. `media-service.js` はメディア情報を `twitter-api-service.js` から取得
5. ダウンロード処理は `download-utils.js` が担当
6. エラーは `error-handlers.js` によってログに記録される
7. スキップ対象のツイートは `list-handlers.js` によって管理される
8. 進捗状況は `progress-bar.js` によって表示される

## エラー処理の流れ

1. ツイート処理中にエラーが発生すると `error-handlers.js` の `logError` 関数が呼ばれる
2. エラータイプに応じてエラーログに記録される
3. 特定のエラータイプ（存在しないツイート、センシティブコンテンツなど）は専用のスキップリストに追加される
4. 連続してAPIエラーが発生した場合は一定時間待機する
5. `fix-skip-lists.js` ツールを実行すると、エラーログからスキップリストが更新される

## 改善点と今後の課題

1. 並列ダウンロードによるパフォーマンス向上
2. Web UIによる操作インターフェースの追加
3. 軽量なデータベースの導入によるメタデータ管理の効率化
4. Twitter APIの認証方法の改善
5. ツイート内容の全文検索機能の追加

## 使用方法

1. Twitterからいいねデータをエクスポートし、`like.js` として保存
2. `node index.js` でダウンロード処理を実行
3. `node fix-skip-lists.js` でスキップリストを最適化

エラーが発生した場合でも、プログラムは続行し、次のツイートを処理します。ダウンロードされたファイルは `downloaded_images` ディレクトリに保存されます。