# Twitter Like Media Downloader 仕様書（Ver.1.x 実装準拠）

## 1. 概要

Twitterからエクスポートした「いいね」データ（like.js）をもとに、いいねしたツイートの画像・動画メディアおよびメタデータを自動でダウンロード・保存するNode.jsアプリケーション。

## 2. 主な機能

### 2.1 いいねデータの読み込み
- ルートディレクトリのlike.jsから、いいねデータ（配列）を抽出・パース。

### 2.2 ダウンロード済み判定
- 保存先ディレクトリ（downloaded_images/）内のファイル名から、既にダウンロード済みのツイートIDを抽出。
- メディアファイル（画像・動画）とメタデータ（-metadata.json）を区別して管理。

### 2.3 スキップリスト管理
- 各種スキップリスト（logs/skip-ids.json, not-found-ids.json, sensitive-ids.json, parse-error-ids.json, no-media-ids.json）を読み込み、該当ツイートIDは処理をスキップ。
- スキップ理由ごとにリストを分離し、エラー発生時は該当リストにIDを追加・保存。

### 2.4 ツイート情報の取得
- 未ダウンロードのツイートIDに対し、twitter-downloaderパッケージのAPIでツイート情報を取得。
- 取得失敗時はリトライ（最大回数・待機時間はconfigで設定）。
- エラータイプ（not_found, sensitive_content, parse, api, network等）を判定し、適切なスキップリストへ分類。

### 2.5 メディアURL抽出・ダウンロード
- 取得したツイート情報からmediaEntitiesを抽出。
- 画像は最大解像度URL、動画は最高ビットレートのmp4を選択。
- オリジナルサイズURLへの変換（pbs.twimg.com/media/… → ?format=xxx&name=orig）。
- 進捗コールバックでダウンロード状況を逐次表示。
- ダウンロード失敗時はエラー記録・スキップ。

### 2.6 メタデータ保存
- ツイート情報をJSON形式で保存（[tweetId]-metadata.json）。
- 保存時にダウンロード日時・アプリバージョン等を付加。

### 2.7 進捗表示
- 全体進捗・個別ファイル進捗をコンソールに多彩なカラープログレスバーで表示。
- ファイル名・サイズ・件数・エラー数・API呼び出し数等の統計も表示。
- インタラクティブモード（スペースで一時停止、+/-で速度調整、qで終了）対応。

### 2.8 エラー処理・ログ
- エラー発生時は詳細をlogs/error-log-[timestamp].jsonに記録。
- 20件ごとに自動保存、プロセス終了時にも保存。
- エラータイプ自動判定・分類。

### 2.9 セーブポイント・再開
- 一定件数ごとに処理状態（インデックス・統計情報）をlogs/download-state.jsonに保存。
- 再実行時に前回の続きから再開可能。

### 2.10 スキップリスト修正ツール
- logs/error-log-*.jsonを解析し、スキップリストを自動分類・再生成するfix-skip-lists.jsを提供。

## 3. 設定・カスタマイズ

- 設定ファイル（src/config/config.js）で各種パス・リトライ回数・進捗表示・インタラクティブモード・サウンド通知等を制御可能。
- 環境変数で一部オプションを上書き可能。

## 4. ディレクトリ構成

- like.js（入力データ）
- downloaded_images/（出力先）
- logs/（エラーログ・スキップリスト・セーブポイント）
- src/（各種サービス・ユーティリティ）

## 5. コマンド

- node index.js … メイン処理
- node fix-skip-lists.js … スキップリスト再分類

---

# Ver.2.0 設計方針・シンプル化案

## 1. シンプル化の基本方針

- 機能は全て維持するが、ファイル分割・冗長なユーティリティ・複雑な進捗表示・多重なスキップリスト管理を極力簡素化。
- 1ファイルまたは最小限の分割で実装。
- 進捗表示はシンプルなテキストバー＋件数・エラー数のみ。
- スキップリストは1ファイル（skip-ids.json）に統合し、理由はID→理由のマップで管理。
- エラーログも1ファイルに集約。
- 設定は冒頭の定数またはJSONで一元管理。
- インタラクティブモード・サウンド通知・多彩なカラーテーマ等は省略または最小限。

## 2. 新仕様（Ver.2.0）

### 2.1 必須要件

- like.jsからいいねデータを抽出し、未ダウンロードのツイートIDを順次処理。
- 既存のメディア・メタデータファイルをスキャンし、重複ダウンロードを防止。
- スキップリスト（skip-ids.json）でスキップ対象を管理。理由も記録。
- ツイート情報取得（twitter-downloader利用、リトライあり）。
- メディアURL抽出・オリジナルサイズ変換・ダウンロード。
- メタデータ保存（[tweetId]-metadata.json）。
- 進捗表示（全体進捗・成功/失敗/スキップ件数）。
- エラー発生時はエラーログ（error-log.json）に記録し、スキップリストに追加。
- セーブポイント（download-state.json）で再開可能。

### 2.2 省略・簡素化するもの

- カラーテーマ・多彩な進捗バー・インタラクティブモード・サウンド通知・詳細な統計・複数スキップリスト・fix-skip-lists.js等の補助ツール。

### 2.3 ファイル構成（例）

- index.js（メイン処理、全ロジックを集約）
- config.json（設定ファイル、なければindex.js内定数で代用）
- like.js（入力データ）
- downloaded_images/（出力先）
- skip-ids.json（スキップID＋理由のマップ）
- error-log.json（エラーログ）
- download-state.json（セーブポイント）

---

# Ver.2.0 実装例（設計方針）

1. index.jsの冒頭で設定・パス・定数を定義。
2. like.jsを読み込み、配列としてパース。
3. downloaded_images/内のファイル名から既存IDを抽出。
4. skip-ids.jsonを読み込み、ID→理由のマップとして保持。
5. download-state.jsonがあれば再開インデックスを取得。
6. forループで未処理IDを順次処理。
   - 既存ID・スキップIDはcontinue。
   - ツイート情報取得（リトライあり）。
   - メディアURL抽出・ダウンロード（失敗時はエラーログ＋スキップID追加）。
   - メタデータ保存。
   - 進捗表示（console.logで件数・進捗率・エラー数）。
   - 一定件数ごとにセーブポイント保存。
7. 終了時に最終統計・エラー件数を表示。